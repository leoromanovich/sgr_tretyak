Цель: уменьшить раздутые/дублированные карточки в `data/obsidian*/persons` за счёт нормализации кандидатов, корректного объединения и дедупа эпизодов. Структура как в `REFACTORING.md`: что меняем, как реализуем, какие проверки/тесты.

## Контекст и проблемы
- Сейчас появляются однословные файлы (`Виктора.md`, `Корина.md`, `Кокорин.md`) и дубли эпизодов из-за того, что в кэш попадают обрывки (фамилии/имена) без сшивки и кластеризатор делит их на отдельные сущности.
- Пример координации: «Иван и Василий Васнецовы» — фамилия общая, нужно развернуть её на оба имени; базовый NER даёт один span.
- Пример раздельных людей: в 8355 «Павел Корин» и «Прасковья Корина» — нельзя сшивать, даже если нет полного ФИО; имя женское → отдельный кластер.

## План работ (шаги реализации)
1) **Нормализация и сшивка в пределах заметки (до кластеризации)**  
   - Место: `src/tools/people_extractor.py` (или пост-обработка перед `persons_local_normalized.jsonl`).  
   - Действия:  
     - Фильтровать одиночные упоминания без фамилии/имени при низкой уверенности.  
     - Сшивать части по offsets: искать последовательности «Имя Отчество Фамилия» и «Имя и Имя Фамилия(ы)»; копировать фамилию на оба имени.  
     - Нормализовать фамилии/имена для сравнения (лемма, ё→е), но хранить исходные surface_forms.  
     - Координации («Иван и Василий Васнецовы»): правило по общему суффиксу фамилии + конъюнкции; опциональный запрос к модели только если детерминированное правило не сработало (несколько имён, общая фамилия).  
   - Защита от ложного слияния: если имена разного рода/пола (Прасковья vs Павел) — не объединять даже при совпадении фамилии.

2) **Усиление кластеризации**  
   - Место: `src/tools/cluster_people.py`.  
   - Действия:  
     - Ввести функцию `should_merge(a, b)`: strong-матч = совпадает нормализованная фамилия + имя/инициал (опционально отчество) → merge; weak-матч только фамилия → merge, если пол/имя совместимы, иначе нет (пример 8355).  
     - Подавление подкластера: если в кластере есть полное ФИО, кандидаты с одной фамилией из того же `note_id` не создают отдельный `GlobalPerson`.  
     - Выбор канонического имени: самая полная тройка ФИО; если нет — фамилия + инициалы; избегать однословных, если есть более полные варианты.  
   - Выход: меньше однословных canonical_full_name, нет слияния Павел/Прасковья.

3) **Генерация заметок**  
   - Место: `src/tools/person_note_generator.py`.  
   - Действия:  
     - Дедуп `episodes` по `note_id` перед рендером (стабильная сортировка).  
     - Если canonical однословное, но есть инициалы/доп. ключ — использовать для disambiguation, без размножения файлов.  
   - Эффект: исчезают дубликаты эпизодов вроде двух записей 8358 у Щусева.

4) **Проверки и тесты**  
   - Юниты:  
     - merge_parts: кейсы «Иван и Василий Васнецовы» → два упоминания с фамилией; «Павел, Прасковья Корина» → два разных.  
     - should_merge: (Павел Корин, Прасковья Корина) → False; (Иван Васнецов, Василий Васнецов) → True; (Корин, Павел Дмитриевич Корин) → True.  
     - episodes_dedup: вход с дублирующими note_id → уникальный список.  
   - Интеграция: `make run_sample`, далее скрипт-метрика:  
     - количество однословных canonical_full_name до/после;  
     - есть ли дублирующиеся `note_id` в person-файлах;  
     - выборочно проверяем 8355 (Павел/Прасковья) и фразу координации (ручной файл/тестовая заметка).

## Почему так
- Входной шум (обрывки имён) создаёт ложные глобальные персоны и дубли эпизодов — лечится на раннем этапе (сшивка/фильтр).  
-.MATCH по фамилии без учёта пола/имени даёт склейку «Павел»+«Прасковья» — нужен штраф по полу/имени и правило “strong vs weak” матчинга.  
- Дубли эпизодов — чисто технический баг при генерации, устраняется дедупом.
